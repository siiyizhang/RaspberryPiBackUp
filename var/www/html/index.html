<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microscope Stream</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .stream-section {
            width: 100%;
            padding: 20px;
            transition: width 0.3s ease;
            position: relative;
        }

        .stream-section.minimized {
            width: 25%;
            transition: width 0.3s ease;
        }

        .stream-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 40px);
        }

        .stream-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .ai-section {
            width: 75%;
            padding: 20px;
            background: #000;
            color: white;
        }

        .ai-section.active {
            display: block;
        }

        .sample-form {
            margin-top: 20px;
        }

        .sample-form textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            color: white;
            font-family: Avenir, Arial, sans-serif;
            resize: vertical;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="stream-section">
            <div class="stream-container">
                <img src="stream.mjpg" alt="Live Stream" id="streamImage">
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="askAI">Ask AI</button>
            </div>
        </div>

    </div>

    <script>
        const WIX_URL = 'https://www.eurekamicroscope.com/ask-ai';  // Replace with your Wix URL
        
        document.getElementById('askAI').addEventListener('click', async () => {
            try {
                // First capture image
                console.log('Attempting to capture image...');
                const response = await fetch('/capture_for_ai', { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`Capture failed with status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Image captured successfully');
                
                // Store in localStorage
                try {
                    localStorage.setItem('microscopeImage', data.image);
                    console.log('Image stored in localStorage');
                } catch (storageError) {
                    console.error('Storage error:', storageError);
                    alert('Error storing image. The image might be too large.');
                    return;
                }
        
                // Start network toggle immediately
                console.log('Toggling network...');
                const networkTogglePromise = fetch('/toggle_network', { method: 'POST' });
        
                // While network is toggling, update UI
                console.log('Updating layout...');
                const streamSection = document.querySelector('.stream-section');
                streamSection.classList.add('minimized');
                document.getElementById('streamImage').src = `data:image/jpeg;base64,${data.image}`;
            
                // Show sample input section
                const aiSection = document.createElement('div');
                aiSection.className = 'ai-section';
                aiSection.style.display = 'block';  
                aiSection.innerHTML = `
                    <p>Sample Analysis</p>
                    <div class="sample-form">
                        <label style="color: white; display: block; margin-bottom: 10px;">What sample are you looking at?</label>
                        <textarea 
                            id="sampleDescription" 
                            placeholder="Be specific (e.g., 'apple skin' rather than 'apple')"
                            style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(255,255,255,0.1); 
                               color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px;"
                        ></textarea>
                        <button id="submitSample" class="btn btn-primary">Submit</button>
                    </div>
                `;
                document.querySelector('.container').appendChild(aiSection);
                console.log('AI section added');
                    
                // Start network toggle in background with retry mechanism
                let networkToggleSuccess = false;
                const toggleNetwork = async () => {
                    try {
                        const networkResponse = await fetch('/toggle_network', { 
                            method: 'POST',
                            // Add shorter timeout
                            signal: AbortSignal.timeout(2000)  // 2 second timeout
                        });
                        if (networkResponse.ok) {
                            networkToggleSuccess = true;
                            console.log('Network toggled successfully');
                        }
                    } catch (error) {
                        console.log('Network toggle attempt failed:', error);
                    }
                };
        
                // Start network toggle
                toggleNetwork();
                    
                // Add submit handler
                document.getElementById('submitSample').onclick = async () => {
                    const description = document.getElementById('sampleDescription').value;
                    if (!description) {
                        alert('Please describe your sample');
                        return;
                    }
                    
                    localStorage.setItem('sampleDescription', description);
        
                    // If network toggle wasn't successful, try again
                    if (!networkToggleSuccess) {
                        try {
                            console.log('Retrying network toggle...');
                            await fetch('/toggle_network', { method: 'POST' });
                            // Wait a moment for connection to establish
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } catch (error) {
                            console.log('Retry failed:', error);
                            // Continue anyway - phone might have auto-connected to mobile data
                        }
                    }
        
                    // Open in new tab
                    window.open('https://www.eurekamicroscope.com/ask-ai', '_blank');
                };
                    
            } catch (error) {
                console.error('Detailed error:', error);
                alert(`Error preparing AI analysis: ${error.message}`);
            }
        });

    </script>
</body>
</html>
